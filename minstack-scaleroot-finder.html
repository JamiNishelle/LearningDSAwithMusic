<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MinStack Scale Root Finder with Audio</title>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useRef } = React;

        // Scale data with MIDI note numbers
        const scalesOriginal = {
            'C Major': [60, 62, 64, 65, 67, 69, 71, 72],
            'C# Major': [61, 63, 65, 66, 68, 70, 72, 73],
            'D Major': [62, 64, 66, 67, 69, 71, 73, 74],
            'Eb Major': [63, 65, 67, 68, 70, 72, 74, 75],
            'E Major': [64, 66, 68, 69, 71, 73, 75, 76],
            'F Major': [65, 67, 69, 70, 72, 74, 76, 77],
            'F# Major': [66, 68, 70, 71, 73, 75, 77, 78],
            'G Major': [67, 69, 71, 72, 74, 76, 78, 79],
            'Ab Major': [68, 70, 72, 73, 75, 77, 79, 80],
            'A Major': [69, 71, 73, 74, 76, 78, 80, 81],
            'Bb Major': [70, 72, 74, 75, 77, 79, 81, 82],
            'B Major': [71, 73, 75, 76, 78, 80, 82, 83],
            'C Minor': [60, 62, 63, 65, 67, 68, 70, 72],
            'D Minor': [62, 64, 65, 67, 69, 70, 72, 74],
            'E Minor': [64, 66, 67, 69, 71, 72, 74, 76],
            'F Minor': [65, 67, 68, 70, 72, 73, 75, 77],
            'G Minor': [67, 69, 70, 72, 74, 75, 77, 79],
            'A Minor': [69, 71, 72, 74, 76, 77, 79, 81],
            'B Minor': [71, 73, 74, 76, 78, 79, 81, 83]
        };

        // MIDI note number to note name mapping
        function midiToNoteName(midi) {
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const octave = Math.floor(midi / 12) - 1;
            const noteName = noteNames[midi % 12];
            return `${noteName}${octave}`;
        }

        // Convert MIDI note to frequency
        function midiToFrequency(midi) {
            return 440 * Math.pow(2, (midi - 69) / 12);
        }

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function ScaleRootFinder() {
            const [selectedScale, setSelectedScale] = useState('D Major');
            const [currentNotes, setCurrentNotes] = useState(scalesOriginal['D Major']);
            const [isShuffled, setIsShuffled] = useState(false);
            const [stackNodes, setStackNodes] = useState([]);
            const [currentStep, setCurrentStep] = useState(0);
            const [isAnimating, setIsAnimating] = useState(false);
            const [rootNote, setRootNote] = useState(null);
            const [message, setMessage] = useState('');
            const [isPlaying, setIsPlaying] = useState(false);
            const audioContextRef = useRef(null);

            // Initialize Audio Context
            const getAudioContext = () => {
                if (!audioContextRef.current) {
                    audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                }
                return audioContextRef.current;
            };

            // Play a single note
            const playNote = (midiNote, duration = 0.5) => {
                const audioContext = getAudioContext();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = midiToFrequency(midiNote);
                oscillator.type = 'sine';

                // Envelope for smooth sound
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            };

            // Play the entire scale
            const playScale = async () => {
                setIsPlaying(true);
                
                for (let i = 0; i < currentNotes.length; i++) {
                    playNote(currentNotes[i], 0.4);
                    await new Promise(resolve => setTimeout(resolve, 450));
                }
                
                setIsPlaying(false);
            };

            // Play just the root note
            const playRootNote = () => {
                if (rootNote !== null) {
                    playNote(rootNote, 1.0);
                }
            };

            function showMessage(msg) {
                setMessage(msg);
                setTimeout(() => setMessage(''), 2500);
            }

            function resetStack() {
                setStackNodes([]);
                setCurrentStep(0);
                setRootNote(null);
                setMessage('');
                setIsAnimating(false);
            }

            function handleScaleChange(scaleName) {
                setSelectedScale(scaleName);
                setCurrentNotes(scalesOriginal[scaleName]);
                setIsShuffled(false);
                resetStack();
            }

            function handleShuffle() {
                const shuffled = shuffleArray(currentNotes);
                setCurrentNotes(shuffled);
                setIsShuffled(true);
                resetStack();
                showMessage('Scale shuffled! MinStack will still find the correct root.');
            }

            async function shuffleAndAnimate() {
                const shuffled = shuffleArray(currentNotes);
                setCurrentNotes(shuffled);
                setIsShuffled(true);
                showMessage('Shuffling and building stack...');
                
                // Wait a moment for the shuffle to be visible
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Then build the stack with the shuffled notes
                buildStackWithNotes(shuffled);
            }

            async function buildStack() {
                buildStackWithNotes(currentNotes);
            }

            async function buildStackWithNotes(midiNotes) {
                resetStack();
                setIsAnimating(true);
                
                const nodes = [];

                for (let i = 0; i < midiNotes.length; i++) {
                    const value = midiNotes[i];
                    const min = nodes.length === 0 ? value : Math.min(value, nodes[nodes.length - 1].min);
                    
                    nodes.push({
                        value,
                        min,
                        noteName: midiToNoteName(value),
                        minNoteName: midiToNoteName(min),
                        id: Date.now() + i
                    });

                    setStackNodes([...nodes]);
                    setCurrentStep(i + 1);
                    showMessage(`Pushed ${value} (${midiToNoteName(value)}) - Current min: ${min}`);
                    
                    // Play the note as it's pushed
                    playNote(value, 0.4);
                    
                    await new Promise(resolve => setTimeout(resolve, 600));
                }

                const root = nodes[nodes.length - 1].min;
                setRootNote(root);
                showMessage(`Root found: ${midiToNoteName(root)} (MIDI ${root})`);
                
                // Play the root note with emphasis
                await new Promise(resolve => setTimeout(resolve, 300));
                playNote(root, 1.5);
                
                setIsAnimating(false);
            }

            function findRootInstantly() {
                resetStack();
                
                const nodes = [];

                for (let i = 0; i < currentNotes.length; i++) {
                    const value = currentNotes[i];
                    const min = nodes.length === 0 ? value : Math.min(value, nodes[nodes.length - 1].min);
                    
                    nodes.push({
                        value,
                        min,
                        noteName: midiToNoteName(value),
                        minNoteName: midiToNoteName(min),
                        id: Date.now() + i
                    });
                }

                setStackNodes(nodes);
                setCurrentStep(currentNotes.length);
                const root = nodes[nodes.length - 1].min;
                setRootNote(root);
                showMessage(`Root found: ${midiToNoteName(root)} (MIDI ${root})`);
                
                // Play just the root note
                playNote(root, 1.5);
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 p-6">
                    <div className="max-w-6xl mx-auto">
                        {/* Header */}
                        <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
                            <h1 className="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 mb-3">
                                ðŸŽµ MinStack Scale Root Finder
                            </h1>
                            <p className="text-gray-600 text-lg">
                                Use MinStack data structure to find and play the root note of any musical scale
                            </p>
                            {isShuffled && (
                                <div className="mt-3 inline-block bg-amber-100 text-amber-800 px-4 py-2 rounded-lg font-semibold text-sm">
                                    ðŸ”€ Scale is shuffled - MinStack will still find the correct root!
                                </div>
                            )}
                        </div>

                        {/* Controls */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div className="grid md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                                        Select Scale
                                    </label>
                                    <select
                                        value={selectedScale}
                                        onChange={(e) => handleScaleChange(e.target.value)}
                                        disabled={isAnimating || isPlaying}
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none text-lg disabled:opacity-50"
                                    >
                                        {Object.keys(scalesOriginal).map(scale => (
                                            <option key={scale} value={scale}>{scale}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="flex items-end gap-3">
                                    <button
                                        onClick={buildStack}
                                        disabled={isAnimating || isPlaying}
                                        className="flex-1 bg-gradient-to-r from-green-500 to-emerald-500 text-white px-6 py-3 rounded-lg font-semibold hover:from-green-600 hover:to-emerald-600 transition disabled:opacity-50 shadow-lg"
                                    >
                                        {isAnimating ? 'ðŸŽµ Building...' : 'â–¶ Animate & Play'}
                                    </button>
                                    <button
                                        onClick={findRootInstantly}
                                        disabled={isAnimating || isPlaying}
                                        className="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition disabled:opacity-50 shadow-lg"
                                    >
                                        âš¡ Find Root
                                    </button>
                                    <button
                                        onClick={resetStack}
                                        disabled={isAnimating || isPlaying}
                                        className="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition disabled:opacity-50 shadow-lg"
                                    >
                                        ðŸ”„ Reset
                                    </button>
                                </div>
                            </div>

                            {/* Shuffle and Audio Controls */}
                            <div className="grid md:grid-cols-2 gap-3 mb-4">
                                <div className="flex gap-3">
                                    <button
                                        onClick={handleShuffle}
                                        disabled={isPlaying || isAnimating}
                                        className="flex-1 bg-gradient-to-r from-amber-500 to-orange-500 text-white px-6 py-3 rounded-lg font-semibold hover:from-amber-600 hover:to-orange-600 transition disabled:opacity-50 shadow-lg"
                                    >
                                        ðŸ”€ Shuffle Scale
                                    </button>
                                    <button
                                        onClick={shuffleAndAnimate}
                                        disabled={isPlaying || isAnimating}
                                        className="flex-1 bg-gradient-to-r from-rose-500 to-pink-500 text-white px-6 py-3 rounded-lg font-semibold hover:from-rose-600 hover:to-pink-600 transition disabled:opacity-50 shadow-lg"
                                    >
                                        ðŸŽ² Shuffle & Animate
                                    </button>
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={playScale}
                                        disabled={isPlaying || isAnimating}
                                        className="flex-1 bg-gradient-to-r from-blue-500 to-cyan-500 text-white px-6 py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-cyan-600 transition disabled:opacity-50 shadow-lg"
                                    >
                                        {isPlaying ? 'ðŸŽµ Playing...' : 'ðŸŽ¹ Play Full Scale'}
                                    </button>
                                    <button
                                        onClick={playRootNote}
                                        disabled={rootNote === null || isPlaying || isAnimating}
                                        className="flex-1 bg-gradient-to-r from-orange-500 to-red-500 text-white px-6 py-3 rounded-lg font-semibold hover:from-orange-600 hover:to-red-600 transition disabled:opacity-50 shadow-lg"
                                    >
                                        ðŸ”Š Play Root
                                    </button>
                                </div>
                            </div>

                            {/* Scale Info Display */}
                            <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 border border-purple-200">
                                <div className="text-sm font-semibold text-gray-700 mb-2">
                                    {selectedScale} Scale - MIDI Notes {isShuffled ? '(Shuffled Order)' : '(Original Order)'}:
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {currentNotes.map((midi, idx) => (
                                        <span
                                            key={idx}
                                            className={`px-3 py-1 rounded-full font-mono text-sm transition ${
                                                idx < currentStep
                                                    ? 'bg-purple-500 text-white'
                                                    : 'bg-white text-gray-600 border border-gray-300'
                                            }`}
                                        >
                                            {midi} ({midiToNoteName(midi)})
                                        </span>
                                    ))}
                                </div>
                            </div>

                            {message && (
                                <div className="mt-4 p-4 bg-gradient-to-r from-amber-100 to-yellow-100 border-l-4 border-amber-500 rounded-lg">
                                    <p className="text-amber-900 font-semibold">{message}</p>
                                </div>
                            )}
                        </div>

                        {/* Visualization */}
                        <div className="grid md:grid-cols-2 gap-6">
                            {/* Stack Visualization */}
                            <div className="bg-white rounded-2xl shadow-xl p-6">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    <span className="text-3xl">ðŸ“š</span>
                                    MinStack Structure
                                </h2>
                                <div className="min-h-[400px] border-2 border-dashed border-purple-300 rounded-xl p-4 bg-gradient-to-b from-purple-50 to-white overflow-y-auto max-h-[600px]">
                                    {stackNodes.length === 0 ? (
                                        <div className="h-full flex items-center justify-center text-gray-400 text-lg">
                                            Empty Stack - Select a scale and click build!
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            {[...stackNodes].reverse().map((node, idx) => {
                                                const isTop = idx === 0;
                                                return (
                                                    <div
                                                        key={node.id}
                                                        className={`relative transition-all duration-300 ${
                                                            isAnimating && idx === 0 ? 'scale-105' : ''
                                                        }`}
                                                    >
                                                        <div className={`rounded-xl p-4 shadow-lg ${
                                                            isTop
                                                                ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white ring-4 ring-green-300'
                                                                : 'bg-gradient-to-r from-blue-400 to-cyan-400 text-white'
                                                        }`}>
                                                            <div className="grid grid-cols-2 gap-4">
                                                                <div>
                                                                    <div className="text-xs opacity-80 mb-1">Value (MIDI)</div>
                                                                    <div className="text-2xl font-bold">{node.value}</div>
                                                                    <div className="text-sm opacity-90">{node.noteName}</div>
                                                                </div>
                                                                <div className="border-l-2 border-white/30 pl-4">
                                                                    <div className="text-xs opacity-80 mb-1">Min (MIDI)</div>
                                                                    <div className="text-2xl font-bold">{node.min}</div>
                                                                    <div className="text-sm opacity-90">{node.minNoteName}</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {isTop && (
                                                            <div className="absolute -top-3 -right-3 bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-xs font-bold shadow-lg animate-pulse">
                                                                HEAD
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Result Display */}
                            <div className="space-y-6">
                                {/* Root Note Display */}
                                <div className="bg-white rounded-2xl shadow-xl p-6">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                        <span className="text-3xl">ðŸŽ¼</span>
                                        Scale Root Note
                                    </h2>
                                    {rootNote !== null ? (
                                        <div className="bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl p-8 text-center text-white shadow-2xl">
                                            <div className="text-6xl font-bold mb-2">{midiToNoteName(rootNote)}</div>
                                            <div className="text-3xl opacity-90 mb-4">MIDI {rootNote}</div>
                                            <div className="text-lg opacity-80 mb-4">Root of {selectedScale}</div>
                                            <button
                                                onClick={playRootNote}
                                                disabled={isPlaying || isAnimating}
                                                className="bg-white text-purple-600 px-6 py-2 rounded-lg font-semibold hover:bg-purple-50 transition disabled:opacity-50"
                                            >
                                                ðŸ”Š Play This Note
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="bg-gray-100 rounded-xl p-8 text-center text-gray-400 border-2 border-dashed border-gray-300">
                                            <div className="text-6xl mb-4">ðŸŽµ</div>
                                            <div className="text-xl">Build the stack to find the root!</div>
                                        </div>
                                    )}
                                </div>

                                {/* How It Works */}
                                <div className="bg-white rounded-2xl shadow-xl p-6">
                                    <h3 className="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2">
                                        <span className="text-2xl">ðŸ’¡</span>
                                        How It Works
                                    </h3>
                                    <div className="space-y-3 text-sm text-gray-700">
                                        <div className="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                                            <strong className="text-blue-700">MinStack:</strong> Each node stores both the value and the minimum value seen so far
                                        </div>
                                        <div className="bg-green-50 p-3 rounded-lg border-l-4 border-green-500">
                                            <strong className="text-green-700">Finding Root:</strong> The root note is the lowest MIDI note in the scale, retrieved via getMin()
                                        </div>
                                        <div className="bg-purple-50 p-3 rounded-lg border-l-4 border-purple-500">
                                            <strong className="text-purple-700">O(1) Operation:</strong> Getting the minimum (root) is constant time!
                                        </div>
                                        <div className="bg-amber-50 p-3 rounded-lg border-l-4 border-amber-500">
                                            <strong className="text-amber-700">Shuffle Test:</strong> Shuffling proves MinStack finds the root regardless of input order!
                                        </div>
                                    </div>
                                </div>

                                {/* Stats */}
                                {stackNodes.length > 0 && (
                                    <div className="bg-gradient-to-r from-indigo-500 to-purple-500 rounded-2xl shadow-xl p-6 text-white">
                                        <h3 className="text-xl font-bold mb-3">Stack Statistics</h3>
                                        <div className="grid grid-cols-2 gap-4 text-center">
                                            <div className="bg-white/20 rounded-lg p-3">
                                                <div className="text-3xl font-bold">{stackNodes.length}</div>
                                                <div className="text-sm opacity-90">Notes in Stack</div>
                                            </div>
                                            <div className="bg-white/20 rounded-lg p-3">
                                                <div className="text-3xl font-bold">{rootNote || 'â€”'}</div>
                                                <div className="text-sm opacity-90">Root (MIDI)</div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="mt-6 text-center text-gray-600 text-sm">
                            <p>Built with React â€¢ MinStack Data Structure â€¢ Web Audio API â€¢ Musical Scale Theory</p>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ScaleRootFinder />);
    </script>
</body>
</html>
